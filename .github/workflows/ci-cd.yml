name: CI/CD Pipeline (NodeJS Microservices)

on:
  push:
    branches: [ "main" ]

jobs:
  ci_cd_pipeline:
    runs-on: self-hosted

    steps:
      # Step 1: Checkout source code
      - uses: actions/checkout@v4

      # Step 2: Allow PowerShell scripts
      - name: Allow PowerShell scripts
        run: Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process
        shell: powershell

      # Step 3: Clean old Docker environment
      - name: Clean old Docker environment
        shell: powershell
        run: |
          Write-Host "Stopping all containers..."
          docker ps -aq | ForEach-Object { docker stop $_; docker rm -f $_ }
          docker network prune -f
          docker volume prune -f
          docker system prune -af
          Write-Host "Docker environment cleaned up!"

      # Step 4: Login DockerHub
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 5: Generate env file for Docker Compose
      - name: Generate env file for Docker Compose
        shell: powershell
        run: |
          $envFile = @"
          DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN=${{ secrets.DOCKERHUB_TOKEN }}
          MONGODB_PRODUCT_URI=${{ secrets.MONGODB_PRODUCT_URI }}
          MONGODB_ORDER_URI=${{ secrets.MONGODB_ORDER_URI }}
          MONGODB_AUTH_URI=${{ secrets.MONGODB_AUTH_URI }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          AUTH_SERVICE_URL=${{ secrets.AUTH_SERVICE_URL }}
          RABBITMQ_URI=${{ secrets.RABBITMQ_URI }}
          RABBITMQ_QUEUE=${{ secrets.RABBITMQ_QUEUE }}
          PRODUCT_PORT=${{ secrets.PRODUCT_PORT }}
          ORDER_PORT=${{ secrets.ORDER_PORT }}
          AUTH_PORT=${{ secrets.AUTH_PORT }}
          API_GATEWAY_PORT=${{ secrets.API_GATEWAY_PORT }}
          "@
          $envFile | Out-File -Encoding ascii -FilePath docker-env
          Write-Host "Env file generated!"
          echo ${{ secrets.DOCKERHUB_USERNAME }}

      # Step 6: Build & run services
      - name: Build and start services
        shell: powershell
        run: |
          docker compose -p eproject down -v --remove-orphans
          docker compose -p eproject up -d --build
          Write-Host "Services built and started!"

      # Step 7: Wait for MongoDB & RabbitMQ
      - name: Wait for MongoDB & RabbitMQ
        shell: powershell
        run: |
          Write-Host "Waiting for MongoDB & RabbitMQ..."
          Start-Sleep -Seconds 15
          docker ps

      # Step 8: Test API (Health Check)
      - name: Test API Health
        shell: powershell
        run: bash ./test_api.sh

      # Step 9: Push image lÃªn DockerHub
      - name: Push images to DockerHub
        shell: powershell
        run: docker compose -p eproject push